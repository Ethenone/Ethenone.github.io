<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Academic Webpage" />
    <meta name="author" content="Tianci Wang" />
    <title>My Travel Map</title>
    <style>
        
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f9fc;
            color: #333;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0;
            font-size: 28px;
        }

        .button-group {
            text-align: center;
            margin: 30px 0;
        }

            .button-group button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 12px 24px;
                margin: 0 10px;
                font-size: 16px;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease;
            }

                .button-group button:hover {
                    background-color: #2980b9;
                    transform: scale(1.05);
                }

        .map-frame {
            width: 95%;
            height: 600px;
            display: none;
            border: 2px solid #ccc;
            margin: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .active {
            display: block;
        }


        #map2 {
            width: 100%;
            height: 600px;
            overflow: hidden;
            border: 2px solid #ccc;
            margin: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* å·¦ä¾§é¢æ¿ï¼ˆå¯æŠ˜å ï¼‰ */
        #leftPane {
            width: 50%;
            min-width: 200px;
            max-width: 100%;
            position: relative;
            transition: width 0.25s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

            #leftPane.collapsed {
                width: 0px;
            }

        /* æŠ˜å æŒ‰é’® */
        #toggleBtn {
            position: absolute;
            top: 10px;
            right: -12px;
            z-index: 10;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid #aaa;
            background: white;
            font-size: 12px;
        }

        /* ä¸­é—´æ‹–æ‹½æ¡ */
        #divider {
            width: 6px;
            cursor: col-resize;
            background: #ddd;
        }

            #divider:hover {
                background: #bbb;
            }

        /* å³ä¾§é¢æ¿ */
        /* å³ä¾§é¢æ¿ï¼šè®©å›¾è¡¨æ§½ä½å¯ä¼¸ç¼© */
        #rightPane {
            flex: 1;
            padding: 10px;
            overflow: hidden; /* åŸæ¥ auto å®¹æ˜“å¯¼è‡´å°ºå¯¸è®¡ç®—æ€ª */
            display: flex;
            flex-direction: column;
            min-height: 0; /* å…³é”®ï¼šå…è®¸å†…éƒ¨ flex å­é¡¹æ­£ç¡®æ”¶ç¼©/æ‰©å±• */
            box-sizing: border-box;
            max-height: 600px;
        }

        /* åœ°å›¾æ—å›¾è¡¨æ§½ä½ï¼šå æ»¡å³ä¾§å‰©ä½™é«˜åº¦ */
        #dockSlot {
            flex: 1;
            min-height: 0; /* å…³é”® */
        }

        /* ä¸‹æ–¹ stats çš„æ§½ä½ï¼šç»™ä¸€ä¸ªæ˜ç¡®é«˜åº¦ï¼ˆä¸ç„¶ canvas ä¼šå¡åœ¨åˆå§‹é«˜åº¦ï¼‰ */
        #statsHistSlot, #statsScatterSlot {
            height: 500px;
            max-height: 100%;
        }

            /* canvas å§‹ç»ˆåƒæ»¡çˆ¶å®¹å™¨ */
            #dockSlot canvas,
            #statsHistSlot canvas,
            #statsScatterSlot canvas {
                width: 100% !important;
                height: 100% !important;
                display: block;
            }

        /* iframe è‡ªé€‚åº” */
        #mapFrame {
            border: none;
            width: 100%;
            height: 100%;
        }


    </style>
    <!-- Icon -->
    <link rel="icon" type="image/x-icon" href="static/assets/favicon.ico" />

    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Google fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap"
          rel="stylesheet" />

    <!-- Core theme CSS (includes Bootstrap)-->
    <link type="text/css" href="static/css/styles.css" rel="stylesheet" />
    <link type="text/css" href="static/css/main.css" rel="stylesheet" />

    <!-- Bootstrap core JS-->
    <script type="text/javascript" src="static/js/bootstrap.bundle.min.js"></script>

    <!-- For Compatability -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Markdown -->
    <script type="text/javascript" src="static/js/marked.min.js"></script>

    <!-- Mathematics -->
    <script>
        // See https://docs.mathjax.org/en/latest/index.html for more details.
        MathJax = {
            tex: {
                packages: {},              // extensions to use
                inlineMath: [              // start/end delimiter pairs for in-line math
                    ['$', '$'],
                    ['\\(', '\\)']
                ],
                displayMath: [             // start/end delimiter pairs for display math
                    ['$$', '$$'],
                    ['\\[', '\\]']
                ],
                processEscapes: false,      // use \$ to produce a literal dollar sign
                processEnvironments: true, // process \begin{xxx}...\end{xxx} outside math mode
                processRefs: true,         // process \ref{...} outside of math mode
                digits: /^(?:[0-9]+(?:\{,\}[0-9]{3})*(?:\.[0-9]*)?|\.[0-9]+)/,    // pattern for recognizing numbers
                tags: 'all',              // or 'ams' or 'all'
                tagSide: 'right',          // side for \tag macros
                tagIndent: '0.8em',        // amount to indent tags
                useLabelIds: true,         // use label name rather than tag for ids
                maxMacros: 10000,          // maximum number of macro substitutions per expression
                maxBuffer: 5 * 1024,       // maximum size for the internal TeX string (5K)
                // baseURL:                   // URL for use with links to tags (when there is a <base> tag in effect)
                // (document.getElementsByTagName('base').length === 0) ? '' : String(document.location).replace(/#.*$/, ''),
                formatError:               // function called when TeX syntax errors occur
                    (jax, err) => jax.formatError(err)
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Core JS-->
    <script type="text/javascript" src="static/js/scripts.js"></script>
    <script type="text/javascript" src="static/js/js-yaml.min.js"></script>
</head>
<body>
    <div id="dragMask" style="
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    display:none;
    z-index: 9999;
    cursor: col-resize;"></div>

    <!-- Navigation-->
    <nav class="header navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
        <div class="container px-5">
            <a id="page-top-title" class="navbar-brand fw-bold" href="index.html"></a>
            <!-- <a href="#page-top"><img src="static/assets/img/CUMT_LOGO.svg" style="width: 11rem;"></a> -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                MENU
                <i class="bi-list"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="resume.html">Resume</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="map.html">Travel map</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Top Section -->
    <section class="top-section" style="background-image: url('static/assets/img/background.jpeg');">
        <div class="top-section-content">
            <div class="container px-5">
                <h2 id="top-section-bg-text" class="text-white display-3 lh-1 font-alt"></h2>
            </div>
        </div>
    </section>
    <!-- Top Section -->
    <header>
        <h1>ğŸ—ºï¸ My Travel Map</h1>
    </header>
    <<div class="button-group">
        <button onclick="showMap('map1')">Straight-line map (airplane,train)</button>
        <button onclick="showMap('map2')">Route map (train)</button>
        <button onclick="showMap('map3')">Route map (cycling)</button>
        <button onclick="showMap('map4')">Straight-line map (cycling)</button><br><br>
        <button onclick="showMap('map5')">Chinese city exploration level</button>
        <button onclick="showMap('map6')">Shanghai exploration</button>
    </div>

    <div>
        <iframe id="map1" class="map-frame active" src="map/map_line.html"></iframe>
        <div id="map2" style="display:none">
            <div id="leftPane">
                <button id="toggleBtn">â®œ</button>
                <iframe id="mapFrame" src="map/map_rail.html"></iframe>
            </div>

            <div id="divider"></div>

            <div id="rightPane">
                <div id="dockControls" style="display:flex;gap:8px;align-items:center;margin:6px 0 10px;">
                    <button id="showScatterBtn">ğŸ“ Scatter</button>
                    <button id="showHistBtn">ğŸ“Š Histogram</button>
                    <button id="switchScatter" style="display:none">Switch Scatter</button>
                </div>

                <!-- åœ°å›¾æ—è¾¹çš„â€œå›¾è¡¨æ§½ä½â€ -->
                <div id="dockSlot" style="position: relative;">
                    <canvas id="scatterChart"></canvas>
                </div>

            </div>

        </div>
        <iframe id="map3" class="map-frame" src="map/map_with_polyline_cityselect.html"></iframe>
        <iframe id="map4" class="map-frame" src="map/straight-line.html"></iframe>
        <iframe id="map5" class="map-frame" src="map/map_city.html"></iframe>
        <iframe id="map6" class="map-frame" src="map/map_shanghai.html"></iframe>
    </div>

    <div id="train-stats" style="display:none;">
        <div id="stats-container"
             style="width:95%;margin:20px auto;padding:25px;background:white;border-radius:16px;
         box-shadow:0 4px 14px rgba(0,0,0,.12);">

            <h2 style="margin-bottom:20px;">ğŸš† Statistics of My Train Ride Records</h2>

            <div id="stats-basic" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                <!-- è‡ªåŠ¨å¡«å…¥ -->
            </div>

            <h3 style="margin-top:30px;">ğŸ“Š Visualization</h3>
            <div id="statsHistSlot" style="position: relative; margin-top:30px;">
                <canvas id="histogramChart"></canvas>
            </div>
            <div id="statsHint" style="margin-top:10px;"></div>
            <canvas id="departChart" style="margin-top:20px;"></canvas>
            <canvas id="arriveChart" style="margin-top:20px;"></canvas>
            <!--<canvas id="scatterChart" style="margin-top:20px;"></canvas>-->
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>


    <script>

        let chartInstances = [];

        function showMap(mapId) {
            const maps = document.getElementsByClassName('map-frame');
            for (let i = 0; i < maps.length; i++) maps[i].classList.remove('active');
            const map2 = document.getElementById('map2');
            map2.style.display = "none";
            document.getElementById(mapId).classList.add('active');


            const stats = document.getElementById('train-stats');

            if (mapId === "map2") {
                map2.style.display = "flex";
                stats.style.display = "block";
                loadStats();
                const ro = new ResizeObserver(() => {
                    // åˆå¹¶å¤šæ¬¡å˜åŒ–ï¼Œé¿å…é¢‘ç¹ resize
                    requestAnimationFrame(resizeAllCharts);
                });

                ["rightPane", "dockSlot", "statsHistSlot", "statsScatterSlot", "map2"].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) ro.observe(el);
                });
                drawDepartChart();
                drawArriveChart();
            } else {
                stats.style.display = "none";
            }
        }

        async function loadStats() {
            const statsData = await (await fetch("data/stats.json")).json();
            const chartsData = await (await fetch("data/charts.json")).json();

            fillBasicStats(statsData);
            drawHistogram(chartsData.durations,chartsData.distances);
            drawScatterChart();
            showDockedChart("hist");
            showDockedChart("scatter");
            requestAnimationFrame(resizeAllCharts);

        }

        function fillBasicStats(data) {
            document.getElementById("stats-basic").innerHTML = `
                    <div><b>Total Tripsï¼š</b> ${data.total_trips}</div>
                    <div><b>Total Tripsï¼š</b> ${data.total_time}</div>
                    <div><b>Longest Trip:</b> ${data.longest_trip.train} ${data.longest_trip.from}â†’${data.longest_trip.to}ï¼ˆ${data.longest_trip.duration}ï¼‰</div>
                    <div><b>Shortest Trip:</b> ${data.shortest_trip.train} ${data.shortest_trip.from}â†’${data.shortest_trip.to}ï¼ˆ${data.shortest_trip.duration}ï¼‰</div>
                    <div><b>Short Trips (â‰¤30 mins):</b> ${data.short_trips}</div>
                    <div><b>Overnight Trips:</b> ${data.overnight_trips}</div>
                    <div><b>Total Distanceï¼š</b> ${data.total_distance}</div>
                    <div><b>Farest Tripï¼š</b> ${data.farest_trip.train} ${data.farest_trip.from}â†’${data.farest_trip.to}ï¼ˆ${data.farest_trip.distance}ï¼‰</div>
                    <div><b>Nearest Tripï¼š</b> ${data.nearest_trip.train} ${data.nearest_trip.from}â†’${data.nearest_trip.to}ï¼ˆ${data.nearest_trip.distance}ï¼‰</div>
                `;
        }

        async function drawDepartChart() {
            const chartsData = await (await fetch("data/charts.json")).json();

            const hours = chartsData.depart_hours;  // æ•´æ•°å°æ—¶åˆ†å¸ƒç”¨

            // -------------------------
            // 1. è½¬æ¢å¤–éƒ¨ç»™å®šæœ€æ—©/æœ€æ™šæ—¶é—´ï¼ˆå«åˆ†é’Ÿï¼‰
            // -------------------------
            function convertHMToFloat(hm) {
                const [h, m] = hm.split(":").map(Number);
                return h + m / 60 - 0.5;
            }

            const earliestFloat = convertHMToFloat(chartsData.earliestdep.time);
            const latestFloat = convertHMToFloat(chartsData.latestdep.time);

            // -------------------------
            // 2. æ•´ç‚¹å°æ—¶åˆ†å¸ƒ bins (0~23)
            // --------------------------
            const bins = new Array(24).fill(0);
            hours.forEach(h => {
                if (h >= 0 && h < 24) bins[h]++;
            });

            // -------------------------
            // 3. ç»˜å›¾
            // -------------------------
            const ctx = document.getElementById("departChart").getContext("2d");

            if (window.departChart instanceof Chart) {
                window.departChart.destroy();
            }

            window.departChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [...Array(24).keys()],  // 0~23
                    datasets: [{
                        label: "Departure Count",
                        data: bins
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Departure Time" },
                            min: 0,
                            max: 23
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Count" }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                earliestLine: {
                                    type: "line",
                                    borderColor: "blue",
                                    borderWidth: 2,
                                    value: earliestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `Earliestï¼š${chartsData.earliestdep.time}`,
                                            `Trainï¼š${chartsData.earliestdep.train}`,
                                            `Fromï¼š${chartsData.earliestdep.from}`,
                                            `Toï¼š${chartsData.earliestdep.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                },
                                latestLine: {
                                    type: "line",
                                    borderColor: "red",
                                    borderWidth: 2,
                                    value: latestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `Latestï¼š${chartsData.latestdep.time}`,
                                            `Trainï¼š${chartsData.latestdep.train}`,
                                            `Fromï¼š${chartsData.latestdep.from}`,
                                            `Toï¼š${chartsData.latestdep.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }


        function hmToFloat(timeStr) {
            const [h, m] = timeStr.split(":").map(Number);
            return h + m / 60;
        }

        function colorForGroup(group) {
            const predefined = {
                G: "rgba(31,119,180,0.65)",
                D: "rgba(255,127,14,0.65)",
                C: "rgba(44,160,44,0.65)",
                S: "rgba(214,39,40,0.65)",
                K: "rgba(148,103,189,0.65)",
                Z: "rgba(140,86,75,0.65)",
                T: "rgba(227,119,194,0.65)",
                "æ•°å­—è½¦æ¬¡": "rgba(255,152,0,0.65)"
            };

            if (predefined[group]) return predefined[group];

            // fallback color
            return "rgba(100,100,100,0.65)";
        }


        function getTrainGroup(train) {
            if (/^[A-Za-z]/.test(train)) {
                return train[0].toUpperCase();   // G / D / C / K / Z / T...
            }
            return "æ•°å­—è½¦æ¬¡";   // pure number
        }

        async function drawScatterChart() {
            const chartsData = await (await fetch("data/charts.json")).json();
            const rides = chartsData.rides;

            // æŒ‰é¦–å­—æ¯ / æ•°å­—åˆ†ç»„
            const groups = {};

            rides.forEach(r => {
                const group = getTrainGroup(r.train);

                if (!groups[group]) groups[group] = [];

                groups[group].push({
                    x: hmToFloat(r.on),
                    y: hmToFloat(r.off),
                    r: Math.max(4, r.duration / 35),

                    _ride: r
                });
            });

            // datasets å»ºç«‹
            const datasets = Object.keys(groups).map(group => ({
                label: group,
                data: groups[group],
                backgroundColor: colorForGroup(group),
                borderColor: colorForGroup(group),
                borderWidth: 1
            }));

            const ctx = document.getElementById("scatterChart").getContext("2d");

            if (window.scatterChart instanceof Chart) window.scatterChart.destroy();

            window.scatterChart = new Chart(ctx, {
                type: "bubble",
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: "linear",
                            min: 0,
                            max: 24,
                            title: { display: true, text: "departure time" }
                        },
                        y: {
                            type: "linear",
                            min: 0,
                            max: 24,
                            title: { display: true, text: "arrival time" }
                        }
                    },
                    plugins: {
                        legend: {
                            position: "right",
                            labels: {
                                usePointStyle: true  // åœ†ç‚¹æ ·å¼æ›´å¥½çœ‹
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const ride = ctx.raw._ride;
                                    const mapFrame = document.getElementById("mapFrame");
                                    mapFrame.contentWindow.postMessage({
                                        type: "highlight_train",
                                        train: ride.train
                                    }, "*");
                                    return `Train:${ride.train} From:${ride.from} To:${ride.to} on:${ride.on} off:${ride.off} duration:${ride.duration}min`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function drawAnotherScatter() {
            const chartsData = await (await fetch("data/charts.json")).json();
            const rides = chartsData.rides;

            // æŒ‰é¦–å­—æ¯ / æ•°å­—åˆ†ç»„
            const groups = {};

            rides.forEach(r => {
                const group = getTrainGroup(r.train);

                if (!groups[group]) groups[group] = [];

                groups[group].push({
                    x: r.distance,
                    y: r.duration,
                    r: 4,

                    _ride: r
                });
            });

            // datasets å»ºç«‹
            const datasets = Object.keys(groups).map(group => ({
                label: group,
                data: groups[group],
                backgroundColor: colorForGroup(group),
                borderColor: colorForGroup(group),
                borderWidth: 1
            }));

            const ctx = document.getElementById("scatterChart").getContext("2d");

            if (window.scatterChart instanceof Chart) window.scatterChart.destroy();

            window.scatterChart = new Chart(ctx, {
                type: "bubble",
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: "linear",
                            min: 0,
                            max: 2400,
                            title: { display: true, text: "distance(km)" }
                        },
                        y: {
                            type: "linear",
                            min: 0,
                            max: 1400,
                            title: { display: true, text: "duration(min)" }
                        }
                    },
                    plugins: {
                        legend: {
                            position: "right",
                            labels: {
                                usePointStyle: true  // åœ†ç‚¹æ ·å¼æ›´å¥½çœ‹
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const ride = ctx.raw._ride;
                                    const mapFrame = document.getElementById("mapFrame");
                                    mapFrame.contentWindow.postMessage({
                                        type: "highlight_train",
                                        train: ride.train
                                    }, "*");
                                    return `Train:${ride.train} From:${ride.from} To:${ride.to} distance:${ride.distance}km duration:${ride.duration}min`;
                                }
                            }
                        }
                    }
                }
            });
        }




        async function drawArriveChart() {
            const chartsData = await (await fetch("data/charts.json")).json();

            const hours = chartsData.arrive_hours;  // æ•´æ•°å°æ—¶åˆ†å¸ƒç”¨

            // -------------------------
            // 1. è½¬æ¢å¤–éƒ¨ç»™å®šæœ€æ—©/æœ€æ™šæ—¶é—´ï¼ˆå«åˆ†é’Ÿï¼‰
            // -------------------------
            function convertHMToFloat(hm) {
                const [h, m] = hm.split(":").map(Number);
                return h + m / 60 - 0.5;
            }

            const earliestFloat = convertHMToFloat(chartsData.earliestarr.time);
            const latestFloat = convertHMToFloat(chartsData.latestarr.time);

            // -------------------------
            // 2. æ•´ç‚¹å°æ—¶åˆ†å¸ƒ bins (0~23)
            // --------------------------
            const bins = new Array(24).fill(0);
            hours.forEach(h => {
                if (h >= 0 && h < 24) bins[h]++;
            });

            // -------------------------
            // 3. ç»˜å›¾
            // -------------------------
            const ctx = document.getElementById("arriveChart").getContext("2d");

            if (window.arriveChart instanceof Chart) {
                window.arriveChart.destroy();
            }

            window.arriveChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [...Array(24).keys()],  // 0~23
                    datasets: [{
                        label: "Arrival Count",
                        data: bins
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Arrival Time" },
                            min: 0,
                            max: 23
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Count" }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                earliestLine: {
                                    type: "line",
                                    borderColor: "blue",
                                    borderWidth: 2,
                                    value: earliestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `Earliestï¼š${chartsData.earliestarr.time}`,
                                            `Trainï¼š${chartsData.earliestarr.train}`,
                                            `Fromï¼š${chartsData.earliestarr.from}`,
                                            `Toï¼š${chartsData.earliestarr.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                },
                                latestLine: {
                                    type: "line",
                                    borderColor: "red",
                                    borderWidth: 2,
                                    value: latestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `Latestï¼š${chartsData.latestarr.time}`,
                                            `Trainï¼š${chartsData.latestarr.train}`,
                                            `Fromï¼š${chartsData.latestarr.from}`,
                                            `Toï¼š${chartsData.latestarr.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawHistogram(durations,distances) {
            // 1. åˆå§‹åŒ– binsï¼ˆ0~600 æ¯ 30 ä¸€ç®±ï¼Œæ€»å…± 21 ä¸ªç®±ï¼‰
            const binSize1 = 30;
            const maxBin1 = 600;
            const bins1 = new Array(maxBin1 / binSize1 + 1).fill(0); // 600/30=20â†’21ä¸ªbin

            // 2. å¡«å……æ•°æ®
            durations.forEach(d => {
                if (d >= maxBin1) {
                    bins1[bins1.length - 1]++;    // æº¢å‡ºç®±
                } else {
                    const index = Math.floor(d / binSize1);
                    bins1[index]++;
                }
            });

            // 3. æ„å»º x è½´åŒºé—´æ ‡ç­¾ï¼Œä¾‹å¦‚ "0-30" "30-60" ... "570â€“600" "600+"
            const labels1 = [];
            for (let i = 0; i < bins1.length - 1; i++) {
                labels1.push(`${i * binSize1}-${(i + 1) * binSize1}`);
            }
            labels1.push("600+");

            // distance
            // 1. åˆå§‹åŒ– binsï¼ˆ0~2000 æ¯ 100 ä¸€ç®±ï¼Œæ€»å…± 21 ä¸ªç®±ï¼‰
            const binSize2 = 100;
            const maxBin2 = 2000;
            const bins2 = new Array(maxBin2 / binSize2 + 1).fill(0); // 2000/100=20â†’21ä¸ªbin

            // 2. å¡«å……æ•°æ®
            distances.forEach(d => {
                if (d >= maxBin2) {
                    bins2[bins2.length - 1]++;    // æº¢å‡ºç®±
                } else {
                    const index = Math.floor(d / binSize2);
                    bins2[index]++;
                }
            });

            // 3. æ„å»º x è½´åŒºé—´æ ‡ç­¾
            const labels2 = [];
            for (let i = 0; i < bins2.length - 1; i++) {
                labels2.push(`${i * binSize2}-${(i + 1) * binSize2}`);
            }
            labels2.push("2000+");



            // 4. ç»˜å›¾
            const ctx = document.getElementById("histogramChart").getContext("2d");

            if (window.histChart) window.histChart.destroy();

            // bins1/labels1: ç¬¬ä¸€ä¸ªç›´æ–¹å›¾
            // bins2/labels2: ç¬¬äºŒä¸ªç›´æ–¹å›¾

            window.histChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [
                        {
                            label: "Travel Duration",
                            data: labels1.map((lab, i) => ({ x: lab, y: bins1[i] })),
                            xAxisID: 'x1',
                            yAxisID: 'y1',
                            borderWidth: 1
                        },
                        {
                            label: "Travel Distance",
                            data: labels2.map((lab, i) => ({ x: lab, y: bins2[i] })),
                            xAxisID: 'x2',
                            yAxisID: 'y2',
                            borderWidth: 1,
                            hidden: true   // é»˜è®¤å…ˆéšè—ç¬¬äºŒä¸ª
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    parsing: false, // å› ä¸ºæˆ‘ä»¬ç”¨ {x,y} å½¢å¼
                    scales: {
                        x1: {
                            type: 'category',
                            labels: labels1,
                            display: true,
                            title: { display: true, text: "Time (min)" }
                        },
                        y1: {
                            beginAtZero: true,
                            display: true,
                            title: { display: true, text: "Count (Chart 1)" }
                        },
                        x2: {
                            type: 'category',
                            labels: labels2,
                            display: false, // é»˜è®¤éšè—ï¼ˆå› ä¸º dataset2 é»˜è®¤ hiddenï¼‰
                            title: { display: true, text: "Distance (km)" }
                        },
                        y2: {
                            beginAtZero: true,
                            display: false,
                            position: 'right',
                            title: { display: true, text: "Count (Chart 2)" }
                        }
                    },
                    plugins: {
                        legend: {
                            onClick: (e, legendItem, legend) => {
                                const chart = legend.chart;
                                const clicked = legendItem.datasetIndex;

                                // åªä¿ç•™è¢«ç‚¹å‡»çš„é‚£ä¸ª dataset æ˜¾ç¤º
                                chart.data.datasets.forEach((ds, i) => {
                                    ds.hidden = (i !== clicked) ? true : !ds.hidden; // å†ç‚¹ä¸€æ¬¡å¯éšè—å®ƒè‡ªå·±
                                });

                                // æ ¹æ®å½“å‰æ˜¾ç¤ºçš„ dataset æ¥åˆ‡æ¢è½´æ˜¾ç¤º
                                const show1 = !chart.data.datasets[0].hidden;
                                const show2 = !chart.data.datasets[1].hidden;

                                chart.options.scales.x1.display = show1;
                                chart.options.scales.y1.display = show1;
                                chart.options.scales.x2.display = show2;
                                chart.options.scales.y2.display = show2;

                                chart.update();
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'nearest',
                            intersect: true,

                            callbacks: {
                                // 1) æ ‡é¢˜ï¼šé»˜è®¤ä¸€èˆ¬å°±æ˜¯ x è½´å¯¹åº”çš„ label
                                title: (items) => {
                                    if (!items.length) return '';
                                    const item = items[0];
                                    label = item.label;
                                    //const start, end;
                                    if (label.endsWith('+')) {
                                        start = Number(label.slice(0, -1));
                                        end = 999999;
                                    }
                                    else  [start, end] = label.split('-').map(Number);
                                    
                                    

                                    const dsLabel = item.dataset?.label ?? '';


                                    const mapFrame = document.getElementById("mapFrame");
                                    mapFrame.contentWindow.postMessage({
                                        type: dsLabel,
                                        start: start,
                                        end: end
                                    }, "*");


                                    return item.label ?? (item.raw && item.raw.x != null ? String(item.raw.x) : '');
                                },

                                // 2) æ¯ä¸€è¡Œï¼šé»˜è®¤æ˜¯ "Dataset Label: Value"
                                label: (item) => {
                                    const dsLabel = item.dataset?.label ?? '';

                                    // Chart.js å·²ç»å¸®ä½ æ ¼å¼åŒ–äº†æ•°å­— -> formattedValue
                                    const value = item.formattedValue ?? '';

                                    // é»˜è®¤å¦‚æœ dsLabel ä¸ºç©ºå°±åªæ˜¾ç¤º value
                                    return dsLabel ? `${dsLabel}: ${value}` : `${value}`;
                                },

                                // 3) é¢œè‰²å°æ–¹å—/markerå¯¹åº”çš„æ–‡å­—ï¼ˆä¸€èˆ¬ä¸éœ€è¦æ”¹ï¼Œä¿æŒé»˜è®¤å³å¯ï¼‰
                                labelColor: (item) => {
                                    const style = item.chart.getDatasetMeta(item.datasetIndex).controller.getStyle(item.dataIndex);
                                    return {
                                        borderColor: style.borderColor,
                                        backgroundColor: style.backgroundColor,
                                        borderWidth: style.borderWidth,
                                        borderDash: style.borderDash,
                                        borderDashOffset: style.borderDashOffset,
                                        borderRadius: 0,
                                    };
                                },

                                // 4) å…¶ä»–é»˜è®¤å›è°ƒï¼šä¸å†™å°±æ˜¯ç©ºï¼ˆç›¸å½“äºé»˜è®¤ï¼‰
                                // afterLabel: () => '',
                                // footer: () => ''
                            }
                        }
                    }
                }
            });
        }
        function switchScatter() {
            const chart = window.scatterChart;
            const axistext = chart.options.scales?.x?.title?.text;
            if (axistext === "departure time") {
                drawAnotherScatter();
            }
            else {
                drawScatterChart();
            };


        }


        function moveCanvasTo(canvasId, targetSlotId) {
            const canvas = document.getElementById(canvasId);
            const slot = document.getElementById(targetSlotId);
            if (!canvas || !slot) return;

            slot.appendChild(canvas);

        }

        function showDockedChart(which) {
            const dockSlot = document.getElementById("dockSlot");
            const statsSlot = document.getElementById("statsHistSlot");  // ç»Ÿä¸€ç”¨ä¸€ä¸ªä¸‹æ–¹æ§½ä½
            const statsHint = document.getElementById("statsHint");

            if (!dockSlot || !statsSlot || !statsHint) return;

            statsHint.innerHTML = "";

            if (which === "scatter") {
                // scatter -> å³ä¾§ï¼›histogram -> ä¸‹æ–¹ï¼ˆçœŸæ­£äº¤æ¢ï¼‰
                moveCanvasTo("scatterChart", "dockSlot");
                moveCanvasTo("histogramChart", "statsHistSlot");

                statsHint.innerHTML = `<button id="bringHistUpBtn">â¬†ï¸ Put Histogram beside the map</button>`;
                document.getElementById("bringHistUpBtn").onclick = () => showDockedChart("hist");
                document.getElementById("switchScatter").style.display = "block";
            } else {
                // histogram -> å³ä¾§ï¼›scatter -> ä¸‹æ–¹ï¼ˆçœŸæ­£äº¤æ¢ï¼‰
                moveCanvasTo("histogramChart", "dockSlot");
                moveCanvasTo("scatterChart", "statsHistSlot");

                statsHint.innerHTML = `<button id="bringScatterUpBtn">â¬†ï¸ Put Scatter beside the map</button>
                <button id="switchScatterBtn">Switch Scatter</button>`;
                document.getElementById("bringScatterUpBtn").onclick = () => showDockedChart("scatter");
                document.getElementById("switchScatterBtn").onclick = () => switchScatter();
                document.getElementById("switchScatter").style.display = "none";
            };

            requestAnimationFrame(resizeAllCharts);
        }

        // ç»‘å®šå³ä¾§ä¸¤ä¸ªæŒ‰é’®
        document.getElementById("showScatterBtn")?.addEventListener("click", () => showDockedChart("scatter"));
        document.getElementById("showHistBtn")?.addEventListener("click", () => showDockedChart("hist"));
        document.getElementById("switchScatter")?.addEventListener("click", () => switchScatter());

        const divider = document.getElementById("divider");
        const leftPane = document.getElementById("leftPane");
        const toggleBtn = document.getElementById("toggleBtn");
        const dragMask = document.getElementById("dragMask");

        let isDragging = false;

        // æ‹–åŠ¨å¼€å§‹
        divider.addEventListener("mousedown", (e) => {
            isDragging = true;
            dragMask.style.display = "block";   // â¬…ï¸ å¯åŠ¨é®ç½©å±‚
        });

        // æ‹–åŠ¨ä¸­
        document.addEventListener("mousemove", (e) => {
            if (!isDragging) return;

            const newWidth = e.clientX;
            if (newWidth > 0 && newWidth < window.innerWidth) {
                leftPane.style.width = newWidth-5 + "px";
            }
            if (newWidth > window.innerWidth - 500) {
                rightPane.style.display = "none";
            }
            else rightPane.style.display = "flex";
        });

        // æ‹–åŠ¨ç»“æŸ
        document.addEventListener("mouseup", (e) => {
            isDragging = false;
            dragMask.style.display = "none"; // â¬…ï¸ å…³é—­é®ç½©å±‚
            resizeAllCharts();
        });


        // æŠ˜å  / å±•å¼€
        toggleBtn.addEventListener("click", () => {
            if (leftPane.classList.contains("collapsed")) {
                leftPane.classList.remove("collapsed");
                leftPane.style.width = "100%";
                rightPane.style.display = "none";
                toggleBtn.textContent = "â®œ";
            } else {
                leftPane.classList.add("collapsed");
                leftPane.style.width = 0;
                rightPane.style.display = "flex";
                toggleBtn.textContent = "â®";
            }
            requestAnimationFrame(resizeAllCharts);
        });

        function resizeAllCharts() {
            if (window.scatterChart instanceof Chart) {
                window.scatterChart.maintainAspectRatio = false;
                window.scatterChart.resize();
            }
            if (window.histChart instanceof Chart) {
                window.histChart.maintainAspectRatio = false;
                window.histChart.resize();
            }
        }
    </script>

    <!-- Footer-->
    <footer class="bg-bottom text-center py-5">
        <div class="container px-5">
            <div class="text-white-50 small">
                <div id="copyright-text" class="mb-2"></div>
                <a id="github-link" href="https://github.com/Ethenone">Github</a>
                <span class="mx-1">&middot;</span>
                <a id="license-link"
                   href="https://github.com/Ethenone/Ethenone.github.io/blob/master/LICENSE">License</a>
            </div>
        </div>
    </footer>

</body>
</html>
