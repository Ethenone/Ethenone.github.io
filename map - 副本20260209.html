<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Academic Webpage" />
    <meta name="author" content="Tianci Wang" />
    <title>My Travel Map</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f9fc;
            color: #333;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0;
            font-size: 28px;
        }

        .button-group {
            text-align: center;
            margin: 30px 0;
        }

            .button-group button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 12px 24px;
                margin: 0 10px;
                font-size: 16px;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.3s ease, transform 0.2s ease;
            }

                .button-group button:hover {
                    background-color: #2980b9;
                    transform: scale(1.05);
                }

        .map-frame {
            width: 95%;
            height: 600px;
            display: none;
            border: 2px solid #ccc;
            margin: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .active {
            display: block;
        }


        #map2 {
            width: 100%;
            height: 600px;
            overflow: hidden;
            border: 2px solid #ccc;
            margin: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Â∑¶‰æßÈù¢ÊùøÔºàÂèØÊäòÂè†Ôºâ */
        #leftPane {
            width: 50%;
            min-width: 200px;
            max-width: 100%;
            position: relative;
            transition: width 0.25s ease;
            display: flex;
            flex-direction: column;
        }

            #leftPane.collapsed {
                width: 0px;
            }

        /* ÊäòÂè†ÊåâÈíÆ */
        #toggleBtn {
            position: absolute;
            top: 10px;
            right: -12px;
            z-index: 10;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid #aaa;
            background: white;
            font-size: 12px;
        }

        /* ‰∏≠Èó¥ÊãñÊãΩÊù° */
        #divider {
            width: 6px;
            cursor: col-resize;
            background: #ddd;
        }

            #divider:hover {
                background: #bbb;
            }

        /* Âè≥‰æßÈù¢Êùø */
        #rightPane {
            flex: 1;
            padding: 10px;
            overflow: auto;
        }

        /* iframe Ëá™ÈÄÇÂ∫î */
        #mapFrame {
            border: none;
            width: 100%;
            height: 100%;
        }

    </style>
    <!-- Icon -->
    <link rel="icon" type="image/x-icon" href="static/assets/favicon.ico" />

    <!-- Bootstrap icons-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Google fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,600;1,600&amp;display=swap"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,300;0,500;0,600;0,700;1,300;1,500;1,600;1,700&amp;display=swap"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;1,400&amp;display=swap"
          rel="stylesheet" />

    <!-- Core theme CSS (includes Bootstrap)-->
    <link type="text/css" href="static/css/styles.css" rel="stylesheet" />
    <link type="text/css" href="static/css/main.css" rel="stylesheet" />

    <!-- Bootstrap core JS-->
    <script type="text/javascript" src="static/js/bootstrap.bundle.min.js"></script>

    <!-- For Compatability -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    <!-- Markdown -->
    <script type="text/javascript" src="static/js/marked.min.js"></script>

    <!-- Mathematics -->
    <script>
        // See https://docs.mathjax.org/en/latest/index.html for more details.
        MathJax = {
            tex: {
                packages: {},              // extensions to use
                inlineMath: [              // start/end delimiter pairs for in-line math
                    ['$', '$'],
                    ['\\(', '\\)']
                ],
                displayMath: [             // start/end delimiter pairs for display math
                    ['$$', '$$'],
                    ['\\[', '\\]']
                ],
                processEscapes: false,      // use \$ to produce a literal dollar sign
                processEnvironments: true, // process \begin{xxx}...\end{xxx} outside math mode
                processRefs: true,         // process \ref{...} outside of math mode
                digits: /^(?:[0-9]+(?:\{,\}[0-9]{3})*(?:\.[0-9]*)?|\.[0-9]+)/,    // pattern for recognizing numbers
                tags: 'all',              // or 'ams' or 'all'
                tagSide: 'right',          // side for \tag macros
                tagIndent: '0.8em',        // amount to indent tags
                useLabelIds: true,         // use label name rather than tag for ids
                maxMacros: 10000,          // maximum number of macro substitutions per expression
                maxBuffer: 5 * 1024,       // maximum size for the internal TeX string (5K)
                // baseURL:                   // URL for use with links to tags (when there is a <base> tag in effect)
                // (document.getElementsByTagName('base').length === 0) ? '' : String(document.location).replace(/#.*$/, ''),
                formatError:               // function called when TeX syntax errors occur
                    (jax, err) => jax.formatError(err)
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script"
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script type="text/javascript" id="MathJax-script" async
            src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Core JS-->
    <script type="text/javascript" src="static/js/scripts.js"></script>
    <script type="text/javascript" src="static/js/js-yaml.min.js"></script>
</head>
<body>
    <div id="dragMask" style="
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    display:none;
    z-index: 9999;
    cursor: col-resize;"></div>

    <!-- Navigation-->
    <nav class="header navbar navbar-expand-lg navbar-light fixed-top shadow-sm" id="mainNav">
        <div class="container px-5">
            <a id="page-top-title" class="navbar-brand fw-bold" href="index.html"></a>
            <!-- <a href="#page-top"><img src="static/assets/img/CUMT_LOGO.svg" style="width: 11rem;"></a> -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                MENU
                <i class="bi-list"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto me-4 my-3 my-lg-0">
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="resume.html">Resume</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link me-lg-3" href="map.html">Travel map</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Top Section -->
    <section class="top-section" style="background-image: url('static/assets/img/background.jpeg');">
        <div class="top-section-content">
            <div class="container px-5">
                <h2 id="top-section-bg-text" class="text-white display-3 lh-1 font-alt"></h2>
            </div>
        </div>
    </section>
    <!-- Top Section -->
    <header>
        <h1>üó∫Ô∏è My Travel Map</h1>
    </header>
    <<div class="button-group">
        <button onclick="showMap('map1')">Straight-line map (airplane,train)</button>
        <button onclick="showMap('map2')">Route map (train)</button>
        <button onclick="showMap('map3')">Route map (cycling)</button>
        <button onclick="showMap('map4')">Straight-line map (cycling)</button><br><br>
        <button onclick="showMap('map5')">Chinese city exploration level</button>
        <button onclick="showMap('map6')">Shanghai exploration</button>
    </div>

    <div>
        <iframe id="map1" class="map-frame active" src="map/map_line.html"></iframe>
        <div id="map2" style="display:none">
            <div id="leftPane">
                <button id="toggleBtn">‚Æú</button>
                <iframe id="mapFrame" src="map/map_rail.html"></iframe>
            </div>

            <div id="divider"></div>

            <div id="rightPane">
                <canvas id="scatterChart"></canvas>
            </div>

        </div>
        <iframe id="map3" class="map-frame" src="map/map_with_polyline_cityselect.html"></iframe>
        <iframe id="map4" class="map-frame" src="map/straight-line.html"></iframe>
        <iframe id="map5" class="map-frame" src="map/map_city.html"></iframe>
        <iframe id="map6" class="map-frame" src="map/map_shanghai.html"></iframe>
    </div>

    <div id="train-stats" style="display:none;">
        <div id="stats-container"
             style="width:95%;margin:20px auto;padding:25px;background:white;border-radius:16px;
         box-shadow:0 4px 14px rgba(0,0,0,.12);">

            <h2 style="margin-bottom:20px;">üöÜ Statistics of My Train Ride Records</h2>

            <div id="stats-basic" style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                <!-- Ëá™Âä®Â°´ÂÖ• -->
            </div>

            <h3 style="margin-top:30px;">üìä Visualization</h3>
            <canvas id="histogramChart" style="margin-top:30px;"></canvas>
            <canvas id="departChart" style="margin-top:20px;"></canvas>
            <canvas id="arriveChart" style="margin-top:20px;"></canvas>
            <!--<canvas id="scatterChart" style="margin-top:20px;"></canvas>-->
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>


    <script>

        let chartInstances = [];

        function showMap(mapId) {
            const maps = document.getElementsByClassName('map-frame');
            for (let i = 0; i < maps.length; i++) maps[i].classList.remove('active');
            const map2 = document.getElementById('map2');
            map2.style.display = "none";
            document.getElementById(mapId).classList.add('active');


            const stats = document.getElementById('train-stats');

            if (mapId === "map2") {
                map2.style.display = "flex";
                stats.style.display = "block";
                loadStats();
                drawDepartChart();
                drawArriveChart();
            } else {
                stats.style.display = "none";
            }
        }

        async function loadStats() {
            const statsData = await (await fetch("data/stats.json")).json();
            const chartsData = await (await fetch("data/charts.json")).json();

            fillBasicStats(statsData);
            drawHistogram(chartsData.durations,chartsData.distances);
            drawScatterChart()

        }

        function fillBasicStats(data) {
            document.getElementById("stats-basic").innerHTML = `
                    <div><b>Total TripsÔºö</b> ${data.total_trips}</div>
                    <div><b>Total TripsÔºö</b> ${data.total_time}</div>
                    <div><b>Longest Trip:</b> ${data.longest_trip.train} ${data.longest_trip.from}‚Üí${data.longest_trip.to}Ôºà${data.longest_trip.duration}Ôºâ</div>
                    <div><b>Shortest Trip:</b> ${data.shortest_trip.train} ${data.shortest_trip.from}‚Üí${data.shortest_trip.to}Ôºà${data.shortest_trip.duration}Ôºâ</div>
                    <div><b>Short Trips (‚â§30 mins):</b> ${data.short_trips}</div>
                    <div><b>Overnight Trips:</b> ${data.overnight_trips}</div>
                    <div><b>Total DistanceÔºö</b> ${data.total_distance}</div>
                    <div><b>Farest TripÔºö</b> ${data.farest_trip.train} ${data.farest_trip.from}‚Üí${data.farest_trip.to}Ôºà${data.farest_trip.distance}Ôºâ</div>
                    <div><b>Nearest TripÔºö</b> ${data.nearest_trip.train} ${data.nearest_trip.from}‚Üí${data.nearest_trip.to}Ôºà${data.nearest_trip.distance}Ôºâ</div>
                `;
        }

        async function drawDepartChart() {
            const chartsData = await (await fetch("data/charts.json")).json();

            const hours = chartsData.depart_hours;  // Êï¥Êï∞Â∞èÊó∂ÂàÜÂ∏ÉÁî®

            // -------------------------
            // 1. ËΩ¨Êç¢Â§ñÈÉ®ÁªôÂÆöÊúÄÊó©/ÊúÄÊôöÊó∂Èó¥ÔºàÂê´ÂàÜÈíüÔºâ
            // -------------------------
            function convertHMToFloat(hm) {
                const [h, m] = hm.split(":").map(Number);
                return h + m / 60 - 0.5;
            }

            const earliestFloat = convertHMToFloat(chartsData.earliestdep.time);
            const latestFloat = convertHMToFloat(chartsData.latestdep.time);

            // -------------------------
            // 2. Êï¥ÁÇπÂ∞èÊó∂ÂàÜÂ∏É bins (0~23)
            // --------------------------
            const bins = new Array(24).fill(0);
            hours.forEach(h => {
                if (h >= 0 && h < 24) bins[h]++;
            });

            // -------------------------
            // 3. ÁªòÂõæ
            // -------------------------
            const ctx = document.getElementById("departChart").getContext("2d");

            if (window.departChart instanceof Chart) {
                window.departChart.destroy();
            }

            window.departChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [...Array(24).keys()],  // 0~23
                    datasets: [{
                        label: "Departure Count",
                        data: bins
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Departure Time" },
                            min: 0,
                            max: 23
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Count" }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                earliestLine: {
                                    type: "line",
                                    borderColor: "blue",
                                    borderWidth: 2,
                                    value: earliestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `EarliestÔºö${chartsData.earliestdep.time}`,
                                            `TrainÔºö${chartsData.earliestdep.train}`,
                                            `FromÔºö${chartsData.earliestdep.from}`,
                                            `ToÔºö${chartsData.earliestdep.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                },
                                latestLine: {
                                    type: "line",
                                    borderColor: "red",
                                    borderWidth: 2,
                                    value: latestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `LatestÔºö${chartsData.latestdep.time}`,
                                            `TrainÔºö${chartsData.latestdep.train}`,
                                            `FromÔºö${chartsData.latestdep.from}`,
                                            `ToÔºö${chartsData.latestdep.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }


        function hmToFloat(timeStr) {
            const [h, m] = timeStr.split(":").map(Number);
            return h + m / 60;
        }

        function colorForGroup(group) {
            const predefined = {
                G: "rgba(31,119,180,0.65)",
                D: "rgba(255,127,14,0.65)",
                C: "rgba(44,160,44,0.65)",
                S: "rgba(214,39,40,0.65)",
                K: "rgba(148,103,189,0.65)",
                Z: "rgba(140,86,75,0.65)",
                T: "rgba(227,119,194,0.65)",
                "Êï∞Â≠óËΩ¶Ê¨°": "rgba(255,152,0,0.65)"
            };

            if (predefined[group]) return predefined[group];

            // fallback color
            return "rgba(100,100,100,0.65)";
        }


        function getTrainGroup(train) {
            if (/^[A-Za-z]/.test(train)) {
                return train[0].toUpperCase();   // G / D / C / K / Z / T...
            }
            return "Êï∞Â≠óËΩ¶Ê¨°";   // pure number
        }

        async function drawScatterChart() {
            const chartsData = await (await fetch("data/charts.json")).json();
            const rides = chartsData.rides;

            // ÊåâÈ¶ñÂ≠óÊØç / Êï∞Â≠óÂàÜÁªÑ
            const groups = {};

            rides.forEach(r => {
                const group = getTrainGroup(r.train);

                if (!groups[group]) groups[group] = [];

                groups[group].push({
                    x: hmToFloat(r.on),
                    y: hmToFloat(r.off),
                    r: Math.max(4, r.duration / 35),

                    _ride: r
                });
            });

            // datasets Âª∫Á´ã
            const datasets = Object.keys(groups).map(group => ({
                label: group,
                data: groups[group],
                backgroundColor: colorForGroup(group),
                borderColor: colorForGroup(group),
                borderWidth: 1
            }));

            const ctx = document.getElementById("scatterChart").getContext("2d");

            if (window.scatterChart instanceof Chart) window.scatterChart.destroy();

            window.scatterChart = new Chart(ctx, {
                type: "bubble",
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    
                    scales: {
                        x: {
                            type: "linear",
                            min: 0,
                            max: 24,
                            title: { display: true, text: "departure time" }
                        },
                        y: {
                            type: "linear",
                            min: 0,
                            max: 24,
                            title: { display: true, text: "arrival time" }
                        }
                    },
                    plugins: {
                        legend: {
                            position: "right",
                            labels: {
                                usePointStyle: true  // ÂúÜÁÇπÊ†∑ÂºèÊõ¥Â•ΩÁúã
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const ride = ctx.raw._ride;
                                    const mapFrame = document.getElementById("mapFrame");
                                    mapFrame.contentWindow.postMessage({
                                        type: "highlight_train",
                                        train: ride.train
                                    }, "*");
                                    return `Train:${ride.train} From:${ride.from} To:${ride.to} on:${ride.on} off:${ride.off} duration:${ride.duration}min`;
                                }
                            }
                        }
                    }
                }
            });
        }




        async function drawArriveChart() {
            const chartsData = await (await fetch("data/charts.json")).json();

            const hours = chartsData.arrive_hours;  // Êï¥Êï∞Â∞èÊó∂ÂàÜÂ∏ÉÁî®

            // -------------------------
            // 1. ËΩ¨Êç¢Â§ñÈÉ®ÁªôÂÆöÊúÄÊó©/ÊúÄÊôöÊó∂Èó¥ÔºàÂê´ÂàÜÈíüÔºâ
            // -------------------------
            function convertHMToFloat(hm) {
                const [h, m] = hm.split(":").map(Number);
                return h + m / 60 - 0.5;
            }

            const earliestFloat = convertHMToFloat(chartsData.earliestarr.time);
            const latestFloat = convertHMToFloat(chartsData.latestarr.time);

            // -------------------------
            // 2. Êï¥ÁÇπÂ∞èÊó∂ÂàÜÂ∏É bins (0~23)
            // --------------------------
            const bins = new Array(24).fill(0);
            hours.forEach(h => {
                if (h >= 0 && h < 24) bins[h]++;
            });

            // -------------------------
            // 3. ÁªòÂõæ
            // -------------------------
            const ctx = document.getElementById("arriveChart").getContext("2d");

            if (window.arriveChart instanceof Chart) {
                window.arriveChart.destroy();
            }

            window.arriveChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [...Array(24).keys()],  // 0~23
                    datasets: [{
                        label: "Arrival Count",
                        data: bins
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: { display: true, text: "Arrival Time" },
                            min: 0,
                            max: 23
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Count" }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                earliestLine: {
                                    type: "line",
                                    borderColor: "blue",
                                    borderWidth: 2,
                                    value: earliestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `EarliestÔºö${chartsData.earliestarr.time}`,
                                            `TrainÔºö${chartsData.earliestarr.train}`,
                                            `FromÔºö${chartsData.earliestarr.from}`,
                                            `ToÔºö${chartsData.earliestarr.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                },
                                latestLine: {
                                    type: "line",
                                    borderColor: "red",
                                    borderWidth: 2,
                                    value: latestFloat,
                                    scaleID: "x",
                                    label: {
                                        content: [
                                            `LatestÔºö${chartsData.latestarr.time}`,
                                            `TrainÔºö${chartsData.latestarr.train}`,
                                            `FromÔºö${chartsData.latestarr.from}`,
                                            `ToÔºö${chartsData.latestarr.to}`
                                        ],
                                        enabled: true,
                                        position: "start"
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawHistogram(durations,distances) {
            // 1. ÂàùÂßãÂåñ binsÔºà0~600 ÊØè 30 ‰∏ÄÁÆ±ÔºåÊÄªÂÖ± 21 ‰∏™ÁÆ±Ôºâ
            const binSize1 = 30;
            const maxBin1 = 600;
            const bins1 = new Array(maxBin1 / binSize1 + 1).fill(0); // 600/30=20‚Üí21‰∏™bin

            // 2. Â°´ÂÖÖÊï∞ÊçÆ
            durations.forEach(d => {
                if (d >= maxBin1) {
                    bins1[bins1.length - 1]++;    // Ê∫¢Âá∫ÁÆ±
                } else {
                    const index = Math.floor(d / binSize1);
                    bins1[index]++;
                }
            });

            // 3. ÊûÑÂª∫ x ËΩ¥Âå∫Èó¥Ê†áÁ≠æÔºå‰æãÂ¶Ç "0-30" "30-60" ... "570‚Äì600" "600+"
            const labels1 = [];
            for (let i = 0; i < bins1.length - 1; i++) {
                labels1.push(`${i * binSize1}-${(i + 1) * binSize1}`);
            }
            labels1.push("600+");

            // distance
            // 1. ÂàùÂßãÂåñ binsÔºà0~2000 ÊØè 100 ‰∏ÄÁÆ±ÔºåÊÄªÂÖ± 21 ‰∏™ÁÆ±Ôºâ
            const binSize2 = 100;
            const maxBin2 = 2000;
            const bins2 = new Array(maxBin2 / binSize2 + 1).fill(0); // 2000/100=20‚Üí21‰∏™bin

            // 2. Â°´ÂÖÖÊï∞ÊçÆ
            distances.forEach(d => {
                if (d >= maxBin2) {
                    bins2[bins2.length - 1]++;    // Ê∫¢Âá∫ÁÆ±
                } else {
                    const index = Math.floor(d / binSize2);
                    bins2[index]++;
                }
            });

            // 3. ÊûÑÂª∫ x ËΩ¥Âå∫Èó¥Ê†áÁ≠æ
            const labels2 = [];
            for (let i = 0; i < bins2.length - 1; i++) {
                labels2.push(`${i * binSize2}-${(i + 1) * binSize2}`);
            }
            labels2.push("2000+");



            // 4. ÁªòÂõæ
            const ctx = document.getElementById("histogramChart").getContext("2d");

            if (window.histChart) window.histChart.destroy();

            // bins1/labels1: Á¨¨‰∏Ä‰∏™Áõ¥ÊñπÂõæ
            // bins2/labels2: Á¨¨‰∫å‰∏™Áõ¥ÊñπÂõæ

            window.histChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [
                        {
                            label: "Travel Duration",
                            data: labels1.map((lab, i) => ({ x: lab, y: bins1[i] })),
                            xAxisID: 'x1',
                            yAxisID: 'y1',
                            borderWidth: 1
                        },
                        {
                            label: "Travel Distance",
                            data: labels2.map((lab, i) => ({ x: lab, y: bins2[i] })),
                            xAxisID: 'x2',
                            yAxisID: 'y2',
                            borderWidth: 1,
                            hidden: true   // ÈªòËÆ§ÂÖàÈöêËóèÁ¨¨‰∫å‰∏™
                        }
                    ]
                },
                options: {
                    responsive: true,
                    parsing: false, // Âõ†‰∏∫Êàë‰ª¨Áî® {x,y} ÂΩ¢Âºè
                    scales: {
                        x1: {
                            type: 'category',
                            labels: labels1,
                            display: true,
                            title: { display: true, text: "Time (min) - 30min bins" }
                        },
                        y1: {
                            beginAtZero: true,
                            display: true,
                            title: { display: true, text: "Count (Chart 1)" }
                        },
                        x2: {
                            type: 'category',
                            labels: labels2,
                            display: false, // ÈªòËÆ§ÈöêËóèÔºàÂõ†‰∏∫ dataset2 ÈªòËÆ§ hiddenÔºâ
                            title: { display: true, text: "Time (min) - 10min bins" }
                        },
                        y2: {
                            beginAtZero: true,
                            display: false,
                            position: 'right',
                            title: { display: true, text: "Count (Chart 2)" }
                        }
                    },
                    plugins: {
                        legend: {
                            onClick: (e, legendItem, legend) => {
                                const chart = legend.chart;
                                const clicked = legendItem.datasetIndex;

                                // Âè™‰øùÁïôË¢´ÁÇπÂáªÁöÑÈÇ£‰∏™ dataset ÊòæÁ§∫
                                chart.data.datasets.forEach((ds, i) => {
                                    ds.hidden = (i !== clicked) ? true : !ds.hidden; // ÂÜçÁÇπ‰∏ÄÊ¨°ÂèØÈöêËóèÂÆÉËá™Â∑±
                                });

                                // Ê†πÊçÆÂΩìÂâçÊòæÁ§∫ÁöÑ dataset Êù•ÂàáÊç¢ËΩ¥ÊòæÁ§∫
                                const show1 = !chart.data.datasets[0].hidden;
                                const show2 = !chart.data.datasets[1].hidden;

                                chart.options.scales.x1.display = show1;
                                chart.options.scales.y1.display = show1;
                                chart.options.scales.x2.display = show2;
                                chart.options.scales.y2.display = show2;

                                chart.update();
                            }
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'nearest',
                            intersect: true,

                            callbacks: {
                                // 1) Ê†áÈ¢òÔºöÈªòËÆ§‰∏ÄËà¨Â∞±ÊòØ x ËΩ¥ÂØπÂ∫îÁöÑ label
                                title: (items) => {
                                    if (!items.length) return '';
                                    const item = items[0];
                                    label = item.label;
                                    //const start, end;
                                    if (label.endsWith('+')) {
                                        start = Number(label.slice(0, -1));
                                        end = 999999;
                                    }
                                    else  [start, end] = label.split('-').map(Number);
                                    
                                    

                                    const dsLabel = item.dataset?.label ?? '';


                                    const mapFrame = document.getElementById("mapFrame");
                                    mapFrame.contentWindow.postMessage({
                                        type: dsLabel,
                                        start: start,
                                        end: end
                                    }, "*");


                                    return item.label ?? (item.raw && item.raw.x != null ? String(item.raw.x) : '');
                                },

                                // 2) ÊØè‰∏ÄË°åÔºöÈªòËÆ§ÊòØ "Dataset Label: Value"
                                label: (item) => {
                                    const dsLabel = item.dataset?.label ?? '';

                                    // Chart.js Â∑≤ÁªèÂ∏Æ‰Ω†Ê†ºÂºèÂåñ‰∫ÜÊï∞Â≠ó -> formattedValue
                                    const value = item.formattedValue ?? '';

                                    // ÈªòËÆ§Â¶ÇÊûú dsLabel ‰∏∫Á©∫Â∞±Âè™ÊòæÁ§∫ value
                                    return dsLabel ? `${dsLabel}: ${value}` : `${value}`;
                                },

                                // 3) È¢úËâ≤Â∞èÊñπÂùó/markerÂØπÂ∫îÁöÑÊñáÂ≠óÔºà‰∏ÄËà¨‰∏çÈúÄË¶ÅÊîπÔºå‰øùÊåÅÈªòËÆ§Âç≥ÂèØÔºâ
                                labelColor: (item) => {
                                    const style = item.chart.getDatasetMeta(item.datasetIndex).controller.getStyle(item.dataIndex);
                                    return {
                                        borderColor: style.borderColor,
                                        backgroundColor: style.backgroundColor,
                                        borderWidth: style.borderWidth,
                                        borderDash: style.borderDash,
                                        borderDashOffset: style.borderDashOffset,
                                        borderRadius: 0,
                                    };
                                },

                                // 4) ÂÖ∂‰ªñÈªòËÆ§ÂõûË∞ÉÔºö‰∏çÂÜôÂ∞±ÊòØÁ©∫ÔºàÁõ∏ÂΩì‰∫éÈªòËÆ§Ôºâ
                                // afterLabel: () => '',
                                // footer: () => ''
                            }
                        }
                    }
                }
            });
        }


        const divider = document.getElementById("divider");
        const leftPane = document.getElementById("leftPane");
        const toggleBtn = document.getElementById("toggleBtn");
        const dragMask = document.getElementById("dragMask");

        let isDragging = false;

        // ÊãñÂä®ÂºÄÂßã
        divider.addEventListener("mousedown", (e) => {
            isDragging = true;
            dragMask.style.display = "block";   // ‚¨ÖÔ∏è ÂêØÂä®ÈÅÆÁΩ©Â±Ç
        });

        // ÊãñÂä®‰∏≠
        document.addEventListener("mousemove", (e) => {
            if (!isDragging) return;

            const newWidth = e.clientX;
            if (newWidth > 0 && newWidth < window.innerWidth) {
                leftPane.style.width = newWidth-5 + "px";
            }
            if (newWidth > window.innerWidth - 500) {
                rightPane.style.display = "none";
            }
            else rightPane.style.display = "block";
        });

        // ÊãñÂä®ÁªìÊùü
        document.addEventListener("mouseup", (e) => {
            isDragging = false;
            dragMask.style.display = "none"; // ‚¨ÖÔ∏è ÂÖ≥Èó≠ÈÅÆÁΩ©Â±Ç
        });


        // ÊäòÂè† / Â±ïÂºÄ
        toggleBtn.addEventListener("click", () => {
            if (leftPane.classList.contains("collapsed")) {
                leftPane.classList.remove("collapsed");
                leftPane.style.width = "100%";
                rightPane.style.display = "none";
                toggleBtn.textContent = "‚Æú";
            } else {
                leftPane.classList.add("collapsed");
                leftPane.style.width = 0;
                rightPane.style.display = "block";
                toggleBtn.textContent = "‚Æû";
            }
        });
    </script>

    <!-- Footer-->
    <footer class="bg-bottom text-center py-5">
        <div class="container px-5">
            <div class="text-white-50 small">
                <div id="copyright-text" class="mb-2"></div>
                <a id="github-link" href="https://github.com/Ethenone">Github</a>
                <span class="mx-1">&middot;</span>
                <a id="license-link"
                   href="https://github.com/Ethenone/Ethenone.github.io/blob/master/LICENSE">License</a>
            </div>
        </div>
    </footer>

</body>
</html>
